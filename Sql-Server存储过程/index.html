
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    

<meta name="description" content="1.概述：什么是存储过程存储过程是一组为了完成特定功能的SQL语句集，经预编译后存储在数据库中的。可以由应用程序调用执行。  有以下几个特点（优点）：1.存储过程是预编译的。在首次运行一个存储过程时，系统对其进行分析，优化，并给出最终存放到系统表中的执行计划,方便之后用户程序的调用。如果某程序需要使">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="SuKai_Coding">
<meta name="twitter:title" content="Sql Server存储过程">
<meta name="twitter:description" content="1.概述：什么是存储过程存储过程是一组为了完成特定功能的SQL语句集，经预编译后存储在数据库中的。可以由应用程序调用执行。  有以下几个特点（优点）：1.存储过程是预编译的。在首次运行一个存储过程时，系统对其进行分析，优化，并给出最终存放到系统表中的执行计划,方便之后用户程序的调用。如果某程序需要使">
<meta name="twitter:creator" content="SuKai_Coding">


    <title>
Sql Server存储过程 | Sukai's Blog
</title>
    <link rel="stylesheet" href="http://sukai.me/static/css/style.css?v=b15c69e1d0b8be12eb69aad2b091f75c" type="text/css" />
    <link rel="stylesheet" href="http://sukai.me/static/css/pygments_style.css?v=f52807bdba7d67ebabc3ce287f67bf67" type="text/css" />
    <link rel="alternate" type="application/rss+xml" href="http://sukai.me/feed.xml" title="Sukai's Blog" />
    <link rel="canonical" href=""/>
    
    

</head>

<body>
<div id="wrap" class="clearfix">
    <div class="pull-left w180">
        <div id="logo">
            <a href="http://sukai.me/"><img src="http://sukai.me/static/imgs/logo.png?v=48119af2491aacbd72cdd480014e9d5f"></a>
        </div>

        <ul id="navigator">
            <li><a href="http://sukai.me/">日志归档</a></li>
            
            <li><a href="http://sukai.me/AboutMe/">关于我</a></li>
            
            <li><a href="http://sukai.me/Board/">交流版块</a></li>
            
            <li><a href="http://sukai.me/friend/">友链</a></li>
            
            <li><a href="http://sukai.me/MyHistory/">苏苏足迹</a></li>
            
            <li><a href="http://sukai.me/MyTrans/">开源翻译</a></li>
            
        </ul>
    </div>

    <div class="pull-right w910">
        
<div class="post-header">
    <h1 class="post-title">Sql Server存储过程</h1>
    <div class="clearfix">
        <div class="post-meta pull-right">Published at May 28, 2014</div>
    </div>
</div>

<div class="post-content">
        <h3>1.概述：什么是存储过程</h3>

<p>存储过程是一组为了完成特定功能的SQL语句集，经预编译后存储在数据库中的。可以由应用程序调用执行。  </p>

<h4>有以下几个特点（优点）：</h4>

<p>1.存储过程是预编译的。在首次运行一个存储过程时，系统对其进行分析，优化，并给出最终存放到系统表中的执行计划,方便之后用户程序的调用。如果某程序需要使用大量T-SQL代码或者需要重复执行某个功能，存储过程执行速度肯定比单纯使用T-SQL批量处理代码要快得多。使用T-SQL批量处理代码，sql server需要每次对其进行编译和优化，而存储过程只需要第一次的编译和优化。  </p>

<p>2.减少了客户机和服务器之间的通信量。应用程序只需要通过网络向服务器发送存储过程的名字和参数，就可以得到自己想要的功能或数据。不像单纯使用数百行的T-SQL代码，这需要向服务器发送数百行的代码。  </p>

<p>3.允许模块化程序设计。存储过程在被创建之后可以被应用程序多次调用执行。使用过程中也可以随时对存储过程进行修改，但对你的应用程序代码毫无影响，大大提高了程序的可移植性。  </p>

<h4>存储过程的分类：</h4>

<p>1.系统存储过程  </p>

<p>2.用户自定义的存储过程  </p>

<h3>2.用户自定义存储过程，基本语法</h3>

<h4>1.变量声明：</h4>
<div class="highlight"><pre>--定义一个存储过程需要使用的变量  
<span class="nb">declare</span> @variable int  
--多变量声明  
<span class="nb">declare</span> @variable int, @va varchar<span class="o">(</span>10<span class="o">)</span>, ....
</pre></div>
<div class="highlight"><pre>--存储过程需要传入的参数变量定义  
@variable int
</pre></div>
<div class="highlight"><pre>--实例  
create procedure procedure_name  
    @variable int                --参数声明  
as  
begin  
    <span class="nb">declare</span> @va varchar<span class="o">(</span>10<span class="o">)</span>      --变量声明  
    <span class="k">select</span> @variable <span class="o">=</span> 22        --变量赋值  
    ...  
end  

--执行存储过程  
<span class="nb">exec </span>procedure 22    --22为传入的参数
</pre></div>

<h4>2.变量赋值</h4>

<p>再变量前加上select 或者 set，但是二者有所不同  </p>
<div class="highlight"><pre><span class="nb">set             </span><span class="k">select</span>  
同时对多个变量同时赋值        不支持            支持  
表达式返回多个值时           出错              将返回的最后一个值赋给变量  
表达式未返回值              变量被赋为null    变量保持原值
</pre></div>

<h4>3.条件控制语句</h4>
<div class="highlight"><pre><span class="k">if</span><span class="o">(</span>condition<span class="o">)</span>  
begin  
    ...  
end
</pre></div>

<h4>4.循环控制语句</h4>
<div class="highlight"><pre><span class="k">while</span><span class="o">(</span>condition<span class="o">)</span>  
begin  
    ...  
end
</pre></div>

<h3>3.实例分析</h3>

<h4>1.带输入参数的存储过程</h4>
<div class="highlight"><pre>--创建存储过程  
create procedure pro_name1  
    @variable varchar<span class="o">(</span>20<span class="o">)</span>               --参数声明  
as   
begin  
    ....  
end  

--执行存储过程  
--参数传递方式1,多个参数以 , 号隔开  
<span class="nb">exec </span>pro_name1 @variable <span class="o">=</span> <span class="s1">&#39;Worlds&#39;</span>     -- 参数传入  
--参数传递方式2  
<span class="nb">exec </span>pro_name1 <span class="s1">&#39;Worlds&#39;</span>                 -- 参数传入
</pre></div>

<h4>2.带输出参数的存储过程</h4>
<div class="highlight"><pre>--创建存储过程  
create procedure pro_name2  
@variable1 varchar<span class="o">(</span>20<span class="o">)</span>,                 --参数声明  
@variable2 varchar<span class="o">(</span>20<span class="o">)</span> output           --输出参数：output标识  
as  
begin  
    ...  
end  

--执行存储过程  
<span class="nb">declare</span> @returnname varchar<span class="o">(</span>20<span class="o">)</span>  
<span class="nb">exec </span>pro_name2 <span class="s1">&#39;Worlds&#39;</span>, @returnname output  -- 参数传入  
<span class="k">select</span> @returnname
</pre></div>

<h3>4.实战分析</h3>
<div class="highlight"><pre>题目：  
假设数据库中有个一个表，为KC表，建表的语句如下。  
CREATE TABLE kc  
<span class="o">(</span>  
    K VARCHAR<span class="o">(</span>100<span class="o">)</span>,  
    V VARCHAR<span class="o">(</span>100<span class="o">)</span>  
<span class="o">)</span>  

要求编写一个存储过程Insert_data，要求完成如下功  

1. 传入2个字符串变量，其中，每个字符串是用分号（；）分隔的字串形式，比如str1<span class="o">=</span>’ab12;ab;cccc;tty’, <span class="nv">str2</span><span class="o">=</span>’1;6sf;8fffff;dd’, 注意，字符串是用户输入的，不能固定值、长度、和分号个数。  
2. 执行完毕存储过程后，要求根据分号提取字符串的字串，并一一插入到表Kc中。例如上面的str1, str2传入后，kc表中数据为：  
k        c  
ab12     1  
ab       6sf  
cccc     8fffff  
tty      dd
</pre></div>

<p>代码如下：  </p>
<div class="highlight"><pre>--建立存储过程insert_data  
create proc insert_data  
    @str1 varchar<span class="o">(</span>max<span class="o">)</span>,  
    @str2 varchar<span class="o">(</span>max<span class="o">)</span>  
as  
begin  
    <span class="nb">declare</span> @len1 int,  
                @len2 int,  
                @start1 int,  
                @start2 int,  
                @pos1 int,  
                @pos2 int,  
                @leftstring1 varchar<span class="o">(</span>max<span class="o">)</span>,  
                @leftstring2 varchar<span class="o">(</span>max<span class="o">)</span>,  
                @substring1 varchar<span class="o">(</span>max<span class="o">)</span>,  
                @substring2 varchar<span class="o">(</span>max<span class="o">)</span>  
    <span class="k">select</span> @len1 <span class="o">=</span> len<span class="o">(</span>@str1<span class="o">)</span>;  
    <span class="k">select</span> @len2 <span class="o">=</span> len<span class="o">(</span>@str2<span class="o">)</span>;  
    <span class="k">select</span> @start1 <span class="o">=</span> 1;  
    <span class="k">select</span> @start2 <span class="o">=</span> 1;  
    <span class="k">select</span> @leftstring1 <span class="o">=</span> <span class="s1">&#39;x&#39;</span>;  
    <span class="k">select</span> @leftstring2 <span class="o">=</span> <span class="s1">&#39;x&#39;</span>;  
    <span class="k">while</span><span class="o">(</span>len<span class="o">(</span>@leftstring1<span class="o">)</span> !<span class="o">=</span>0 or len<span class="o">(</span>@leftstring2<span class="o">)</span> !<span class="o">=</span> 0 <span class="o">)</span>  
    begin  
        <span class="k">select</span> @pos1 <span class="o">=</span> charindex<span class="o">(</span><span class="s1">&#39;;&#39;</span>, @str1, @start1<span class="o">)</span>;  
        <span class="k">select</span> @pos2 <span class="o">=</span> charindex<span class="o">(</span><span class="s1">&#39;;&#39;</span>, @str2, @start2<span class="o">)</span>;  
        <span class="k">if</span><span class="o">(</span>@pos1 <span class="o">=</span> 0 and @pos2 <span class="o">=</span> 0<span class="o">)</span>  
        begin  
            <span class="k">select</span> @substring1 <span class="o">=</span> substring<span class="o">(</span>@str1, @start1 , @len1-@start1+1<span class="o">)</span>;  
            <span class="k">select</span> @substring2 <span class="o">=</span> substring<span class="o">(</span>@str2, @start2 , @len2-@start2+1<span class="o">)</span>;  
            <span class="k">select</span> @leftstring1 <span class="o">=</span> NULL;  
            <span class="k">select</span> @leftstring2 <span class="o">=</span> NULL;  
        end  
        <span class="k">else if</span><span class="o">(</span>@pos1 <span class="o">=</span> 0 and @pos2 !<span class="o">=</span> 0<span class="o">)</span>  
        begin  
            <span class="k">select</span> @substring1 <span class="o">=</span> substring<span class="o">(</span>@str1, @start1 , @len1-@start1+1<span class="o">)</span>;  
            <span class="k">select</span> @substring2 <span class="o">=</span> substring<span class="o">(</span>@str2, @start2 , @pos2-@start2<span class="o">)</span>;  
            <span class="k">select</span> @start1 <span class="o">=</span> @len1 + 1;  
            <span class="k">select</span> @start2 <span class="o">=</span> @pos2 + 1;  
            <span class="k">select</span> @leftstring1 <span class="o">=</span> NULL;  
            <span class="k">select</span> @leftstring2 <span class="o">=</span> substring<span class="o">(</span>@str2, @start2, @len2-@start2+1<span class="o">)</span>;  
        end  
        <span class="k">else if</span><span class="o">(</span>@pos1 !<span class="o">=</span> 0 and @pos2 <span class="o">=</span> 0<span class="o">)</span>  
        begin  
            <span class="k">select</span> @substring1 <span class="o">=</span> substring<span class="o">(</span>@str1, @start1 , @pos1-@start1<span class="o">)</span>;  
            <span class="k">select</span> @substring2 <span class="o">=</span> substring<span class="o">(</span>@str2, @start2 , @len2-@start2+1<span class="o">)</span>;  
            <span class="k">select</span> @start1 <span class="o">=</span> @pos1 + 1;  
            <span class="k">select</span> @start2 <span class="o">=</span> @len2 + 1;  
            <span class="k">select</span> @leftstring1 <span class="o">=</span> substring<span class="o">(</span>@str1, @start1, @len1-@start1+1<span class="o">)</span>;  
            <span class="k">select</span> @leftstring2 <span class="o">=</span> NULL;  
        end  
        <span class="k">else  </span>
<span class="k">        </span>begin  
            <span class="k">select</span> @substring1<span class="o">=</span>substring<span class="o">(</span>@str1, @start1,@pos1-@start1<span class="o">)</span>;  
            <span class="k">select</span> @substring2<span class="o">=</span>substring<span class="o">(</span>@str2, @start2,@pos2-@start2<span class="o">)</span>;  
            <span class="k">select</span> @start1<span class="o">=</span>@pos1+1;  
            <span class="k">select</span> @start2<span class="o">=</span>@pos2+1;  
            <span class="k">select</span> @leftstring1 <span class="o">=</span> substring<span class="o">(</span>@str1, @start1, @len1-@start1+1<span class="o">)</span>;  
            <span class="k">select</span> @leftstring2 <span class="o">=</span> substring<span class="o">(</span>@str2, @start2, @len2-@start2+1<span class="o">)</span>;  
        end  
        insert into kc values<span class="o">(</span>@substring1, @substring2<span class="o">)</span>;  
    end  
end
</pre></div>
<div class="highlight"><pre>---执行存储过程  
execute insert_data <span class="s1">&#39;a;b;c;d;;f&#39;</span>, <span class="s1">&#39;e;f;g;h;z;l;m&#39;</span>
</pre></div>

        
        <div class="post-meta pull-right">
            Tagged in :
            
            <a href="http://sukai.me/tag/Sql-Server/">Sql Server</a>
            
        </div>
        
        
    
        
        
            <div class="ds-thread"></div>
            <script type="text/javascript">
                var duoshuoQuery = {short_name:"sukai-me"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';
                    ds.async = true;
                    ds.src = 'http://static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
        
    

</div>

    </div>

</div>
</body>

</html>